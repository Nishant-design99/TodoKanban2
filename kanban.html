<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paper Style Kanban App - Due Dates</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --font-family: 'Inter', sans-serif;
            
            /* Light Theme Variables */
            --bg-body-light: #f7f3e9; 
            --bg-app-header-light: #ffffff;
            --text-app-header-light: #2c3e50; 
            --shadow-app-header-light: 0 2px 4px rgba(0,0,0,0.05);
            --bg-controls-light: #ffffff;
            --shadow-controls-light: 0 2px 4px rgba(0,0,0,0.05);
            --bg-column-light: #ffffff; 
            --text-column-title-light: #34495e; 
            --border-column-title-light: #e0e0e0;
            --bg-task-card-light: #fefefe; 
            --text-task-card-light: #333333;
            --border-task-card-light: #f0f0f0;
            --shadow-column-light: 0 3px 6px rgba(0,0,0,0.08);
            --shadow-task-card-light: 0 1px 3px rgba(0,0,0,0.06);
            --button-primary-bg-light: #3b82f6; 
            --button-primary-text-light: #ffffff;
            --button-primary-hover-bg-light: #2563eb;
            --button-secondary-bg-light: #6b7280; 
            --button-secondary-text-light: #ffffff;
            --button-secondary-hover-bg-light: #4b5563;
            --button-tertiary-bg-light: #e5e7eb; 
            --button-tertiary-text-light: #374151;
            --button-tertiary-hover-bg-light: #d1d5db;
            --input-bg-light: #ffffff;
            --input-border-light: #d1d5db;
            --input-text-light: #374151;
            --input-placeholder-text-light: #9ca3af; 
            --input-focus-border-light: #3b82f6;
            --input-focus-shadow-light: rgba(59, 130, 246, 0.2);
            --text-completed-light: #7f8c8d; 
            --bg-column-last-light: #f4f6f7; 
            --task-card-last-bg-light: #fdfdfd;
            --task-card-last-opacity-light: 0.85;
            --drag-over-bg-light: rgba(0, 0, 0, 0.03);
            --delete-btn-color-light: #e74c3c; 
            --delete-btn-hover-color-light: #c0392b;
            --toggle-bg-light: #cbd5e1;
            --toggle-fg-light: #ffffff;
            --toggle-active-bg-light: #3b82f6;
            --due-date-color-light: #555;
            --due-date-overdue-color-light: #e74c3c;

            /* Dark Theme Variables */
            --bg-body-dark: #2c3e50; 
            --bg-app-header-dark: #34495e; 
            --text-app-header-dark: #ecf0f1; 
            --shadow-app-header-dark: 0 2px 4px rgba(0,0,0,0.2);
            --bg-controls-dark: #34495e;
            --shadow-controls-dark: 0 2px 4px rgba(0,0,0,0.2);
            --bg-column-dark: #3b5368; 
            --text-column-title-dark: #ecf0f1;
            --border-column-title-dark: #4a6278;
            --bg-task-card-dark: #4a6278; 
            --text-task-card-dark: #f0f0f0;
            --border-task-card-dark: #526c81;
            --shadow-column-dark: 0 3px 6px rgba(0,0,0,0.25);
            --shadow-task-card-dark: 0 1px 3px rgba(0,0,0,0.2);
            --button-primary-bg-dark: #4a90e2; 
            --button-primary-text-dark: #ffffff;
            --button-primary-hover-bg-dark: #357abd;
            --button-secondary-bg-dark: #718096; 
            --button-secondary-text-dark: #ffffff;
            --button-secondary-hover-bg-dark: #5a677a;
            --button-tertiary-bg-dark: #4a5568; 
            --button-tertiary-text-dark: #e2e8f0;
            --button-tertiary-hover-bg-dark: #2d3748;
            --input-bg-dark: #34495e;
            --input-border-dark: #526c81;
            --input-text-dark: #ecf0f1;
            --input-placeholder-text-dark: #95a5a6; 
            --input-focus-border-dark: #4a90e2;
            --input-focus-shadow-dark: rgba(74, 144, 226, 0.25);
            --text-completed-dark: #95a5a6; 
            --bg-column-last-dark: #2f4354; 
            --task-card-last-bg-dark: #3a5063;
            --task-card-last-opacity-dark: 0.8;
            --drag-over-bg-dark: rgba(255, 255, 255, 0.05);
            --delete-btn-color-dark: #ff7675; 
            --delete-btn-hover-color-dark: #e74c3c;
            --toggle-bg-dark: #4a6278;
            --toggle-fg-dark: #ecf0f1;
            --toggle-active-bg-dark: #4a90e2;
            --due-date-color-dark: #bdc3c7;
            --due-date-overdue-color-dark: #ff7675;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-body);
            color: var(--text-task-card);
            transition: background-color 0.3s ease, color 0.3s ease;
            background-image: var(--bg-body-texture, none);
        }
        body.light-mode {
            --bg-body: var(--bg-body-light);
            --bg-app-header: var(--bg-app-header-light);
            --text-app-header: var(--text-app-header-light);
            --shadow-app-header: var(--shadow-app-header-light);
            --bg-controls: var(--bg-controls-light);
            --shadow-controls: var(--shadow-controls-light);
            --bg-column: var(--bg-column-light);
            --text-column-title: var(--text-column-title-light);
            --border-column-title: var(--border-column-title-light);
            --bg-task-card: var(--bg-task-card-light);
            --text-task-card: var(--text-task-card-light);
            --border-task-card: var(--border-task-card-light);
            --shadow-column: var(--shadow-column-light);
            --shadow-task-card: var(--shadow-task-card-light);
            --button-primary-bg: var(--button-primary-bg-light);
            --button-primary-text: var(--button-primary-text-light);
            --button-primary-hover-bg: var(--button-primary-hover-bg-light);
            --button-secondary-bg: var(--button-secondary-bg-light);
            --button-secondary-text: var(--button-secondary-text-light);
            --button-secondary-hover-bg: var(--button-secondary-hover-bg-light);
            --button-tertiary-bg: var(--button-tertiary-bg-light);
            --button-tertiary-text: var (--button-tertiary-text-light);
            --button-tertiary-hover-bg: var(--button-tertiary-hover-bg-light);
            --current-input-bg: var(--input-bg-light);
            --current-input-border: var(--input-border-light);
            --current-input-text: var(--input-text-light);
            --current-input-placeholder-text: var(--input-placeholder-text-light);
            --current-input-focus-border: var(--input-focus-border-light);
            --current-input-focus-shadow: var(--input-focus-shadow-light);
            --text-completed: var(--text-completed-light);
            --bg-column-last: var(--bg-column-last-light);
            --task-card-last-bg: var(--task-card-last-bg-light);
            --task-card-last-opacity: var(--task-card-last-opacity-light);
            --drag-over-bg: var(--drag-over-bg-light);
            --delete-btn-color: var(--delete-btn-color-light);
            --delete-btn-hover-color: var(--delete-btn-hover-color-light);
            --toggle-bg: var(--toggle-bg-light);
            --toggle-fg: var (--toggle-fg-light);
            --toggle-active-bg: var(--toggle-active-bg-light);
            --due-date-color: var(--due-date-color-light);
            --due-date-overdue-color: var(--due-date-overdue-color-light);
            --bg-body-texture: radial-gradient(circle, rgba(0,0,0,0.01) 1px, transparent 1px);
            background-size: 5px 5px;
        }

        body.dark-mode {
            --bg-body: var(--bg-body-dark);
            --bg-app-header: var(--bg-app-header-dark);
            --text-app-header: var(--text-app-header-dark);
            --shadow-app-header: var(--shadow-app-header-dark);
            --bg-controls: var(--bg-controls-dark);
            --shadow-controls: var(--shadow-controls-dark);
            --bg-column: var(--bg-column-dark);
            --text-column-title: var(--text-column-title-dark);
            --border-column-title: var(--border-column-title-dark);
            --bg-task-card: var(--bg-task-card-dark);
            --text-task-card: var(--text-task-card-dark);
            --border-task-card: var(--border-task-card-dark);
            --shadow-column: var(--shadow-column-dark);
            --shadow-task-card: var(--shadow-task-card-dark);
            --button-primary-bg: var(--button-primary-bg-dark);
            --button-primary-text: var(--button-primary-text-dark);
            --button-primary-hover-bg: var(--button-primary-hover-bg-dark);
            --button-secondary-bg: var(--button-secondary-bg-dark);
            --button-secondary-text: var(--button-secondary-text-dark);
            --button-secondary-hover-bg: var(--button-secondary-hover-bg-dark);
            --button-tertiary-bg: var(--button-tertiary-bg-dark);
            --button-tertiary-text: var(--button-tertiary-text-dark);
            --button-tertiary-hover-bg: var(--button-tertiary-hover-bg-dark);
            --current-input-bg: var(--input-bg-dark);
            --current-input-border: var(--input-border-dark);
            --current-input-text: var(--input-text-dark);
            --current-input-placeholder-text: var(--input-placeholder-text-dark);
            --current-input-focus-border: var(--input-focus-border-dark);
            --current-input-focus-shadow: var(--input-focus-shadow-dark);
            --text-completed: var(--text-completed-dark);
            --bg-column-last: var(--bg-column-last-dark);
            --task-card-last-bg: var(--task-card-last-bg-dark);
            --task-card-last-opacity: var(--task-card-last-opacity-dark);
            --drag-over-bg: var(--drag-over-bg-dark);
            --delete-btn-color: var(--delete-btn-color-dark);
            --delete-btn-hover-color: var(--delete-btn-hover-color-dark);
            --toggle-bg: var(--toggle-bg-dark);
            --toggle-fg: var(--toggle-fg-dark);
            --toggle-active-bg: var(--toggle-active-bg-dark);
            --due-date-color: var(--due-date-color-dark);
            --due-date-overdue-color: var(--due-date-overdue-color-dark);
            --bg-body-texture: none;
        }

        .app-header {
            background-color: var(--bg-app-header);
            box-shadow: var(--shadow-app-header);
            padding: 16px 24px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s ease;
        }
        .app-header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-app-header);
            transition: color 0.3s ease;
        }
        .theme-switch-wrapper { display: flex; align-items: center; }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 44px; }
        .theme-switch input { display:none; }
        .slider { background-color: var(--toggle-bg); bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 24px; }
        .slider:before { background-color: var(--toggle-fg); bottom: 3px; content: ""; height: 18px; left: 3px; position: absolute; transition: .4s; width: 18px; border-radius: 50%; }
        input:checked + .slider { background-color: var(--toggle-active-bg); }
        input:checked + .slider:before { transform: translateX(20px); }

        .controls-wrapper {
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
            display: flex;
            justify-content: space-between;
            align-items: flex-start; 
            padding: 20px;
            gap: 20px;
            margin-bottom: 20px;
            background-color: var(--bg-controls);
            border-radius: 10px;
            box-shadow: var(--shadow-controls);
            transition: background-color 0.3s ease;
        }

        .main-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-grow: 1;
        }
        
        .themed-input {
            padding: 10px 14px;
            border: 1px solid var(--current-input-border);
            font-size: 0.95rem;
            background-color: var(--current-input-bg);
            color: var(--current-input-text);
            transition: border-color 0.2s, box-shadow 0.2s, background-color 0.3s, color 0.3s;
            height: 40px; 
            border-radius: 6px;
        }
        .themed-input::placeholder {
            color: var(--current-input-placeholder-text);
            opacity: 0.7;
        }
        .themed-input:focus {
            outline: none;
            border-color: var(--current-input-focus-border);
            box-shadow: 0 0 0 2px var(--current-input-focus-shadow);
        }
        
        body.dark-mode .themed-input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
        body.light-mode .themed-input[type="date"]::-webkit-calendar-picker-indicator {
            filter: none; 
        }


        #newTaskInput { 
            border-radius: 6px 0 0 6px; 
            width: 100%; 
            min-width: 150px;
        }
        #newTaskDueDateInput { 
            border-radius: 0; 
            width: auto; 
            min-width: 130px;
        }
        .column-title-edit-input { /* Class for column rename input */
            min-width: 150px; /* Ensure it has some width */
            flex-grow: 1;
            margin-right: 8px; /* Space before save/cancel buttons */
        }


        .button-base {
            padding: 10px 16px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s ease, transform 0.1s ease;
            height: 40px; 
            display: flex;
            align-items: center;
            gap: 6px;
            border-radius: 6px;
        }
        .button-primary {
            background-color: var(--button-primary-bg);
            color: var(--button-primary-text);
        }
        .button-primary:hover { background-color: var(--button-primary-hover-bg); }
        
        .button-secondary {
            background-color: var(--button-secondary-bg);
            color: var(--button-secondary-text);
        }
        .button-secondary:hover { background-color: var(--button-secondary-hover-bg); }

        .button-tertiary { 
            background-color: var (--button-tertiary-bg);
            color: var(--button-tertiary-text);
        }
        .button-tertiary:hover { background-color: var(--button-tertiary-hover-bg); }

        /* Small buttons for column rename save/cancel */
        .button-small {
            padding: 6px 10px;
            height: 32px; /* Smaller height */
            font-size: 0.875rem; /* Smaller font */
        }

        /* Add styles for the small icon button */
        .button-icon-only {
            padding: 8px;
            border-radius: 6px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .button-icon-only .button-icon {
            width: 20px;
            height: 20px;
        }

        #addTaskBtn { 
             border-radius: 0 6px 6px 0; 
        }
        
        #columnManagementContainer {
            display: flex; 
            align-items: center;
        }
        #inlineColumnForm { 
            gap: 10px; 
        }
        .hidden { display: none !important; }


        .button-icon { width: 16px; height: 16px; fill: currentColor; }

        /* Column reordering styles */
        .kanban-column.reorder-mode {
            cursor: move;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .kanban-column.reorder-mode:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-column), 0 8px 16px rgba(0,0,0,0.1);
        }

        .kanban-column.reorder-mode.dragging {
            opacity: 0.7;
            transform: scale(1.02) rotate(1deg);
        }

        .reorder-placeholder {
            border: 2px dashed var(--current-input-focus-border);
            background-color: var(--drag-over-bg);
            border-radius: 8px;
            margin: 0 12px;
            min-width: 310px;
            transition: all 0.2s ease;
        }

        .kanban-board { 
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
            display: flex; 
            justify-content: flex-start; 
            padding: 24px; 
            gap: 24px; 
            overflow-x: auto; 
            min-height: 500px; 
        }

        .kanban-column { background-color: var(--bg-column); border-radius: 8px; padding: 18px; width: 310px; min-width: 310px; height: fit-content; min-height: 450px; box-shadow: var(--shadow-column); display: flex; flex-direction: column; transition: transform 0.2s ease-in-out, background-color 0.3s ease; }
        .kanban-column:hover { transform: translateY(-3px); }
        .kanban-column.is-last-column { background-color: var(--bg-column-last); }
        
        .column-header { /* Wrapper for title and edit form */
            display: flex;
            justify-content: center; /* Center title or edit form */
            align-items: center;
            margin-bottom: 18px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-column-title);
            min-height: 40px; /* Ensure space for edit form */
            position: relative; /* For absolute positioning of error message if needed */
        }
        .column-title-display { /* The H2 title */
            color: var(--text-column-title);
            font-weight: 600;
            font-size: 1.15rem;
            cursor: pointer; /* Indicate it's clickable */
            transition: color 0.3s ease;
            text-align: center;
            flex-grow: 1; /* Allow title to take space */
        }
        .column-title-display:hover {
            opacity: 0.8;
        }
        .column-title-edit-form { /* The form for editing title */
            display: flex;
            align-items: center;
            width: 100%; /* Take full width of header */
        }


        .tasks-container { min-height: 350px; border-radius: 6px; padding-top: 8px; flex-grow: 1; }
        .tasks-container.drag-over-active { background-color: var(--drag-over-bg); outline: 2px dashed var(--current-input-focus-border); outline-offset: -2px; }
        
        .task-card { background-color: var(--bg-task-card); border: 1px solid var(--border-task-card); border-radius: 6px; padding: 10px 14px; margin-bottom: 10px; cursor: grab; box-shadow: var(--shadow-task-card); transition: box-shadow 0.2s ease-in-out, transform 0.2s ease-in-out, background-color 0.3s, border-color 0.3s; word-wrap: break-word; color: var(--text-task-card); }
        .task-card:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .task-card.dragging { opacity: 0.6; transform: scale(1.02) rotate(2deg); border: 2px dashed var(--current-input-focus-border); }
        .task-card .task-text { display: block; margin-bottom: 5px; }
        .task-card .task-text.task-completed { text-decoration: line-through; color: var(--text-completed); transition: color 0.3s ease; }
        .task-card .task-due-date { font-size: 0.8rem; color: var(--due-date-color); transition: color 0.3s ease; }
        .task-card .task-due-date.overdue { color: var(--due-date-overdue-color); font-weight: 500; }
        .kanban-column.is-last-column .task-card { background-color: var(--task-card-last-bg); opacity: var(--task-card-last-opacity); }
        
        .delete-task-btn { float: right; background: none; border: none; color: var(--delete-btn-color); cursor: pointer; font-size: 1rem; padding: 0 0 0 6px; transition: color 0.2s ease; }
        .delete-task-btn:hover { color: var(--delete-btn-hover-color); }
        
        input.input-error::placeholder, .input-error { /* General error style for inputs */
            color: var(--delete-btn-color) !important; 
            opacity: 0.8 !important;
            border-color: var(--delete-btn-color) !important;
        }


        /* Responsive adjustments */
        @media (max-width: 900px) {
            .controls-wrapper {
                flex-direction: column;
                align-items: stretch;
            }
            .main-controls {
                flex-direction: column;
                align-items: stretch;
                width: 100%;
            }
            .main-controls > div { 
                width: 100%;
            }
            .main-controls > div:not(:last-child) {
                 margin-bottom: 10px;
            }
            #newTaskInput, #newTaskDueDateInput, #addTaskBtn { 
                border-radius: 6px !important; 
                width: 100%;
            }
             #newTaskDueDateInput { 
                margin-top: 0; 
            }
            #addTaskBtn {
                 margin-top: 0;
                 justify-content: center;
            }
            #columnManagementContainer {
                margin-top: 15px;
                width: 100%;
            }
            #triggerAddColumnInputBtn, #inlineColumnForm {
                width: 100%;
            }
            #inlineColumnForm {
                flex-direction: column; 
                align-items: stretch;
            }
            #inlineColumnForm input, #inlineColumnForm button {
                width: 100%;
                margin-bottom: 10px;
            }
            #inlineColumnForm button:last-child {
                margin-bottom: 0;
            }
        }
        @media (max-width: 768px) {
            .app-header h1 { font-size: 1.5rem; }
            .controls-wrapper { margin-left: 16px; margin-right: 16px; padding: 16px; }
            .kanban-board { padding: 16px; gap: 16px; }
            .kanban-column { width: calc(100% - 16px); min-width: unset; margin-left: auto; margin-right: auto; }
        }
    </style>
</head>
<body class="light-mode">

    <header class="app-header">
        <h1>Kanban Paper</h1>
        <div class="theme-switch-wrapper">
            <label class="theme-switch" for="themeToggleCheckbox">
                <input type="checkbox" id="themeToggleCheckbox">
                <span class="slider round"></span>
            </label>
        </div>
    </header>

    <div class="controls-wrapper mt-4 mx-auto max-w-5xl">
        <div class="main-controls">
            <div class="flex-grow"> 
                <input type="text" id="newTaskInput" placeholder="Enter a new task..." class="w-full themed-input">
            </div>
            <div> 
                 <input type="date" id="newTaskDueDateInput" class="themed-input">
            </div>
            <div> 
                <button id="addTaskBtn" class="button-base button-primary">
                    <svg class="button-icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path></svg>
                    Add Task
                </button>
            </div>
        </div>
        <div id="columnManagementContainer">
            <div class="flex gap-2">
                <button id="triggerAddColumnInputBtn" class="button-base button-secondary">
                    <svg class="button-icon" viewBox="0 0 20 20" fill="currentColor"><path d="M3 3a1 1 0 000 2v10a1 1 0 001 1h12a1 1 0 001-1V5a1 1 0 000-2H3zm11 1H6v8h8V4z"></path><path d="M17 9h2a1 1 0 010 2h-2v2a1 1 0 11-2 0v-2h-2a1 1 0 110-2h2V7a1 1 0 112 0v2z"></path></svg>
                    Add New Column
                </button>
                <button id="reorderColumnsBtn" class="button-base button-tertiary button-icon-only" title="Reorder Columns">
                    <svg class="button-icon" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-8.486 8.486-4.343 1.515 1.515-4.343 8.486-8.486zM12.172 5l2.828 2.828-8.486 8.486-2.828-2.828L12.172 5zM4.83 15.17l1.5-4.25 2.75 2.75-4.25 1.5z"/>
                    </svg>
                </button>
            </div>
            <div id="inlineColumnForm" class="hidden flex items-center">
                <input type="text" id="inlineNewColumnNameInput" placeholder="Column Name" class="themed-input"> 
                <button id="saveInlineColumnBtn" class="button-base button-primary">Save</button>
                <button id="cancelInlineColumnBtn" class="button-base button-tertiary">Cancel</button>
            </div>
        </div>
    </div>

    <div class="kanban-board" id="kanbanBoard">
        </div>

    <script>
        // DOM Elements
        const newTaskInput = document.getElementById('newTaskInput');
        const newTaskDueDateInput = document.getElementById('newTaskDueDateInput');
        const addTaskBtn = document.getElementById('addTaskBtn');
        
        const triggerAddColumnInputBtn = document.getElementById('triggerAddColumnInputBtn');
        const inlineColumnForm = document.getElementById('inlineColumnForm');
        const inlineNewColumnNameInput = document.getElementById('inlineNewColumnNameInput');
        const saveInlineColumnBtn = document.getElementById('saveInlineColumnBtn');
        const cancelInlineColumnBtn = document.getElementById('cancelInlineColumnBtn');

        const kanbanBoard = document.getElementById('kanbanBoard');
        const themeToggle = document.getElementById('themeToggleCheckbox');

        // --- Theme Management ---
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.body.classList.remove('light-mode');
                document.body.classList.add('dark-mode');
                themeToggle.checked = true;
            } else {
                document.body.classList.remove('dark-mode');
                document.body.classList.add('light-mode');
                themeToggle.checked = false;
            }
        }
        function toggleTheme() {
            const newTheme = themeToggle.checked ? 'dark' : 'light';
            applyTheme(newTheme);
            localStorage.setItem('kanbanTheme', newTheme);
        }
        const savedTheme = localStorage.getItem('kanbanTheme') || 'light';
        applyTheme(savedTheme);
        themeToggle.addEventListener('change', toggleTheme);

        // --- Helper: Update Task Style ---
        function updateTaskCardStyle(taskCardElement, columnElement) {
            const taskTextSpan = taskCardElement.querySelector('.task-text');
            const dueDateSpan = taskCardElement.querySelector('.task-due-date');
            if (!taskTextSpan) return;

            const columnsNodeList = kanbanBoard.querySelectorAll('.kanban-column');
            const isLast = columnsNodeList.length > 0 && columnElement.id === columnsNodeList[columnsNodeList.length - 1].id;

            if (isLast) {
                taskTextSpan.classList.add('task-completed');
            } else {
                taskTextSpan.classList.remove('task-completed');
            }

            if (dueDateSpan && dueDateSpan.dataset.dueDate) {
                const today = new Date();
                today.setHours(0,0,0,0); 
                const dueDate = new Date(dueDateSpan.dataset.dueDate + "T00:00:00"); 
                if (!isLast && dueDate < today) {
                    dueDateSpan.classList.add('overdue');
                } else {
                    dueDateSpan.classList.remove('overdue');
                }
            }
        }
        
        function updateAllColumnStyles() {
            const columnElements = kanbanBoard.querySelectorAll('.kanban-column');
            columnElements.forEach((colEl, index) => {
                if (index === columnElements.length - 1 && columnElements.length > 0) {
                    colEl.classList.add('is-last-column');
                } else {
                    colEl.classList.remove('is-last-column');
                }
                colEl.querySelectorAll('.task-card').forEach(taskCard => {
                    updateTaskCardStyle(taskCard, colEl);
                });
            });
        }

        function displayInputError(inputElement, message) {
            const originalPlaceholder = inputElement.placeholder;
            inputElement.value = ''; 
            inputElement.placeholder = message;
            inputElement.classList.add('input-error'); 
            
            setTimeout(() => {
                inputElement.placeholder = originalPlaceholder;
                inputElement.classList.remove('input-error');
            }, 2500);
        }

        // --- Core Task Functions ---
        function createTaskElement(task) {
            const taskCard = document.createElement('div');
            taskCard.classList.add('task-card');
            taskCard.setAttribute('draggable', 'true');
            taskCard.setAttribute('data-task-id', task.id);
            
            const taskTextSpan = document.createElement('span');
            taskTextSpan.classList.add('task-text');
            taskTextSpan.textContent = task.text;
            taskCard.appendChild(taskTextSpan);

            if (task.dueDate) {
                const dueDateSpan = document.createElement('span');
                dueDateSpan.classList.add('task-due-date');
                const dateParts = task.dueDate.split('-');
                const localDate = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));
                dueDateSpan.textContent = `Due: ${localDate.toLocaleDateString()}`;
                dueDateSpan.dataset.dueDate = task.dueDate;
                taskCard.appendChild(dueDateSpan);
            }

            const deleteBtn = document.createElement('button');
            deleteBtn.classList.add('delete-task-btn');
            deleteBtn.innerHTML = '&times;'; 
            deleteBtn.onclick = function() { deleteTask(task.id); };
            taskCard.appendChild(deleteBtn);

            taskCard.addEventListener('dragstart', (event) => {
                event.dataTransfer.setData('text/plain', task.id);
                event.target.classList.add('dragging');
            });
            taskCard.addEventListener('dragend', (event) => { event.target.classList.remove('dragging'); });
            return taskCard;
        }

        function addTask() {
            const taskText = newTaskInput.value.trim();
            const taskDueDate = newTaskDueDateInput.value; 

            if (taskText === '') {
                displayInputError(newTaskInput, 'Task cannot be empty!');
                return;
            }

            const newTask = { 
                id: 'task-' + Date.now(), 
                text: taskText,
                dueDate: taskDueDate || null 
            };
            const firstColumnTasksContainer = kanbanBoard.querySelector('.kanban-column .tasks-container');
            
            if (!firstColumnTasksContainer) {
                alert('Please add a column first!'); 
                return;
            }
            
            const taskElement = createTaskElement(newTask);
            firstColumnTasksContainer.appendChild(taskElement);
            updateTaskCardStyle(taskElement, firstColumnTasksContainer.closest('.kanban-column'));
            
            newTaskInput.value = '';
            newTaskDueDateInput.value = ''; 
            saveStateToLocalStorage();
        }

        function deleteTask(taskId) {
            const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
            if (taskElement) {
                taskElement.remove();
                saveStateToLocalStorage();
                updateAllColumnStyles();
            }
        }
        
        // --- Column Renaming Functions ---
        function enableColumnRename(columnHeaderDiv, columnTitleDisplay) {
            const currentTitle = columnTitleDisplay.textContent;
            columnTitleDisplay.classList.add('hidden'); 

            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentTitle;
            input.classList.add('themed-input', 'column-title-edit-input'); 
            input.originalValue = currentTitle; 

            const saveBtn = document.createElement('button');
            saveBtn.textContent = 'Save';
            saveBtn.classList.add('button-base', 'button-primary', 'button-small');
            saveBtn.onclick = () => saveColumnRename(columnHeaderDiv, input, columnTitleDisplay);

            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Cancel';
            cancelBtn.classList.add('button-base', 'button-tertiary', 'button-small');
            cancelBtn.onclick = () => cancelColumnRename(columnHeaderDiv, columnTitleDisplay, input.originalValue);
            
            const editForm = document.createElement('div');
            editForm.classList.add('column-title-edit-form', 'flex', 'items-center'); 
            editForm.appendChild(input);
            editForm.appendChild(saveBtn);
            editForm.appendChild(cancelBtn);

            columnHeaderDiv.appendChild(editForm);
            input.focus();
            input.select();

            input.onkeydown = (event) => {
                if (event.key === 'Enter') {
                    saveColumnRename(columnHeaderDiv, input, columnTitleDisplay);
                } else if (event.key === 'Escape') {
                    cancelColumnRename(columnHeaderDiv, columnTitleDisplay, input.originalValue);
                }
            };
        }

        function saveColumnRename(columnHeaderDiv, inputElement, columnTitleDisplay) {
            const newTitle = inputElement.value.trim();
            const columnElement = columnHeaderDiv.closest('.kanban-column');
            const columnId = columnElement.dataset.columnId;

            if (newTitle === '') {
                displayInputError(inputElement, 'Name cannot be empty!');
                inputElement.focus(); 
                return;
            }

            const existingColumnTitles = Array.from(kanbanBoard.querySelectorAll('.kanban-column'))
                                             .filter(col => col.dataset.columnId !== columnId) 
                                             .map(col => col.querySelector('.column-title-display').textContent.trim().toLowerCase());
            if (existingColumnTitles.includes(newTitle.toLowerCase())) {
                displayInputError(inputElement, 'Name already exists!');
                inputElement.focus(); 
                return;
            }

            columnTitleDisplay.textContent = newTitle;
            finishColumnRename(columnHeaderDiv, columnTitleDisplay);
            saveStateToLocalStorage(); 
        }

        function cancelColumnRename(columnHeaderDiv, columnTitleDisplay, originalTitle) {
            columnTitleDisplay.textContent = originalTitle; 
            finishColumnRename(columnHeaderDiv, columnTitleDisplay);
        }

        function finishColumnRename(columnHeaderDiv, columnTitleDisplay) {
            const editForm = columnHeaderDiv.querySelector('.column-title-edit-form');
            if (editForm) {
                columnHeaderDiv.removeChild(editForm);
            }
            columnTitleDisplay.classList.remove('hidden'); 
        }


        // --- Core Column Functions (with inline form for adding new columns) ---
        function showInlineColumnForm() {
            triggerAddColumnInputBtn.classList.add('hidden');
            inlineColumnForm.classList.remove('hidden');
            inlineNewColumnNameInput.value = ''; 
            inlineNewColumnNameInput.focus();
        }

        function hideInlineColumnForm() {
            inlineColumnForm.classList.add('hidden');
            triggerAddColumnInputBtn.classList.remove('hidden');
            inlineNewColumnNameInput.classList.remove('input-error'); 
            inlineNewColumnNameInput.placeholder = "Column Name"; 
        }

        function saveNewInlineColumn() {
            const columnName = inlineNewColumnNameInput.value.trim();
            if (columnName === '') {
                displayInputError(inlineNewColumnNameInput, 'Column name cannot be empty!');
                return;
            }

            const columnId = 'column-' + columnName.toLowerCase().replace(/\s+/g, '-') + '-' + Date.now();
            const existingColumnTitles = Array.from(kanbanBoard.querySelectorAll('.kanban-column .column-title-display'))
                                             .map(h2 => h2.textContent.trim().toLowerCase());
            if (existingColumnTitles.includes(columnName.toLowerCase())) {
                displayInputError(inlineNewColumnNameInput, 'Column name already exists!');
                return;
            }

            const newColumnElement = createColumnDOM(columnId, columnName);
            kanbanBoard.appendChild(newColumnElement);
            updateAllColumnStyles(); 
            saveStateToLocalStorage();
            hideInlineColumnForm(); 
        }

        function createColumnDOM(id, title) {
            const columnDiv = document.createElement('div');
            columnDiv.classList.add('kanban-column');
            columnDiv.id = id;
            columnDiv.dataset.columnId = id;

            const columnHeaderDiv = document.createElement('div');
            columnHeaderDiv.classList.add('column-header');

            const titleDisplay = document.createElement('h2'); 
            titleDisplay.classList.add('column-title-display');
            titleDisplay.textContent = title;
            titleDisplay.onclick = () => {
                if (!columnHeaderDiv.querySelector('.column-title-edit-form')) {
                    enableColumnRename(columnHeaderDiv, titleDisplay);
                }
            };
            
            columnHeaderDiv.appendChild(titleDisplay); 
            columnDiv.appendChild(columnHeaderDiv); 

            const tasksDiv = document.createElement('div');
            tasksDiv.classList.add('tasks-container');

            tasksDiv.addEventListener('dragover', (event) => { event.preventDefault(); tasksDiv.classList.add('drag-over-active'); });
            tasksDiv.addEventListener('dragleave', () => { tasksDiv.classList.remove('drag-over-active'); });
            tasksDiv.addEventListener('dragenter', (event) => { event.preventDefault(); });
            tasksDiv.addEventListener('drop', (event) => {
                event.preventDefault();
                tasksDiv.classList.remove('drag-over-active');
                const taskId = event.dataTransfer.getData('text/plain');
                const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
                let dropTargetContainer = event.target.closest('.tasks-container') || event.target;
                if (taskElement && dropTargetContainer && dropTargetContainer.classList.contains('tasks-container')) {
                    dropTargetContainer.appendChild(taskElement);
                    updateAllColumnStyles(); 
                    saveStateToLocalStorage();
                }
            });
            columnDiv.appendChild(tasksDiv);
            return columnDiv;
        }

        // --- Local Storage ---
        function saveStateToLocalStorage() {
            const boardState = { columns: [], tasksByColumn: {} };
            const currentColumnElements = kanbanBoard.querySelectorAll('.kanban-column');

            currentColumnElements.forEach(columnEl => {
                const columnId = columnEl.dataset.columnId;
                const columnTitle = columnEl.querySelector('.column-title-display').textContent; 
                boardState.columns.push({ id: columnId, title: columnTitle });
                boardState.tasksByColumn[columnId] = [];
                const taskCardsInColumn = columnEl.querySelectorAll('.task-card');
                taskCardsInColumn.forEach(card => {
                    const dueDateSpan = card.querySelector('.task-due-date');
                    boardState.tasksByColumn[columnId].push({
                        id: card.dataset.taskId,
                        text: card.querySelector('.task-text').textContent,
                        dueDate: dueDateSpan ? dueDateSpan.dataset.dueDate : null
                    });
                });
            });
            localStorage.setItem('kanbanBoardState', JSON.stringify(boardState));
        }

        function loadStateFromLocalStorage() {
            kanbanBoard.innerHTML = ''; 
            const storedBoardState = localStorage.getItem('kanbanBoardState');

            if (storedBoardState) {
                const boardState = JSON.parse(storedBoardState);
                boardState.columns.forEach(colData => {
                    const newColumnEl = createColumnDOM(colData.id, colData.title);
                    kanbanBoard.appendChild(newColumnEl);
                });

                for (const columnId in boardState.tasksByColumn) {
                    if (boardState.tasksByColumn.hasOwnProperty(columnId)) {
                        const columnElement = document.getElementById(columnId);
                        if (columnElement) {
                            const tasksContainer = columnElement.querySelector('.tasks-container');
                            boardState.tasksByColumn[columnId].forEach(taskData => {
                                const task = { 
                                    id: taskData.id, 
                                    text: taskData.text,
                                    dueDate: taskData.dueDate || null 
                                };
                                const taskElement = createTaskElement(task);
                                tasksContainer.appendChild(taskElement);
                            });
                        }
                    }
                }
            } else { 
                const defaultColumns = [
                    { id: 'todo-' + Date.now(), title: 'To Do' },
                    { id: 'inprogress-' + Date.now(), title: 'In Progress' },
                    { id: 'done-' + Date.now(), title: 'Done' }
                ];
                defaultColumns.forEach(colData => {
                    const defaultColEl = createColumnDOM(colData.id, colData.title);
                    kanbanBoard.appendChild(defaultColEl);
                });
            }
            updateAllColumnStyles(); 
            if (!storedBoardState) { saveStateToLocalStorage(); }
        }

        // --- Event Listeners ---
        addTaskBtn.addEventListener('click', addTask);
        newTaskInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') addTask(); });
        
        triggerAddColumnInputBtn.addEventListener('click', showInlineColumnForm);
        saveInlineColumnBtn.addEventListener('click', saveNewInlineColumn);
        cancelInlineColumnBtn.addEventListener('click', hideInlineColumnForm);
        inlineNewColumnNameInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') saveNewInlineColumn(); });

        // Column reordering functionality
        const reorderColumnsBtn = document.getElementById('reorderColumnsBtn');
        let isReorderMode = false;

        function toggleReorderMode() {
            isReorderMode = !isReorderMode;
            const columns = document.querySelectorAll('.kanban-column');
            
            if (isReorderMode) {
                reorderColumnsBtn.classList.remove('button-tertiary');
                reorderColumnsBtn.classList.add('button-primary');
                columns.forEach(column => {
                    column.classList.add('reorder-mode');
                    setupColumnDragEvents(column);
                });
            } else {
                reorderColumnsBtn.classList.remove('button-primary');
                reorderColumnsBtn.classList.add('button-tertiary');
                columns.forEach(column => {
                    column.classList.remove('reorder-mode');
                    removeColumnDragEvents(column);
                });
            }
        }

        function setupColumnDragEvents(column) {
            column.setAttribute('draggable', true);
            
            column.addEventListener('dragstart', handleColumnDragStart);
            column.addEventListener('dragend', handleColumnDragEnd);
            column.addEventListener('dragover', handleColumnDragOver);
            column.addEventListener('drop', handleColumnDrop);
        }

        function removeColumnDragEvents(column) {
            column.removeAttribute('draggable');
            
            column.removeEventListener('dragstart', handleColumnDragStart);
            column.removeEventListener('dragend', handleColumnDragEnd);
            column.removeEventListener('dragover', handleColumnDragOver);
            column.removeEventListener('drop', handleColumnDrop);
        }

        function handleColumnDragStart(e) {
            e.target.classList.add('dragging');
            e.dataTransfer.setData('text/plain', e.target.id);
        }

        function handleColumnDragEnd(e) {
            e.target.classList.remove('dragging');
        }

        function handleColumnDragOver(e) {
            e.preventDefault();
            const draggingColumn = document.querySelector('.kanban-column.dragging');
            if (!draggingColumn) return;

            const columns = [...kanbanBoard.querySelectorAll('.kanban-column:not(.dragging)')];
            const nextColumn = columns.find(column => {
                const rect = column.getBoundingClientRect();
                const columnCenter = rect.left + rect.width / 2;
                return e.clientX < columnCenter;
            });

            if (nextColumn) {
                kanbanBoard.insertBefore(draggingColumn, nextColumn);
            } else {
                kanbanBoard.appendChild(draggingColumn);
            }
        }

        function handleColumnDrop(e) {
            e.preventDefault();
            const columnId = e.dataTransfer.getData('text/plain');
            const draggingColumn = document.getElementById(columnId);
            const dropTarget = e.target.closest('.kanban-column');
            
            if (draggingColumn && dropTarget) {
                if (e.clientX < dropTarget.getBoundingClientRect().left + dropTarget.offsetWidth / 2) {
                    kanbanBoard.insertBefore(draggingColumn, dropTarget);
                } else {
                    kanbanBoard.insertBefore(draggingColumn, dropTarget.nextSibling);
                }
                updateAllColumnStyles();
                saveStateToLocalStorage();
            }
        }

        reorderColumnsBtn.addEventListener('click', toggleReorderMode);

        // Update existing event listeners...
        document.addEventListener('DOMContentLoaded', () => {
            loadStateFromLocalStorage(); 
            const currentTheme = localStorage.getItem('kanbanTheme') || 'light';
            applyTheme(currentTheme);
        });
    </script>
</body>
</html>
